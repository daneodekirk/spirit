/*! spirit Tue Feb 04 2014 14:03:57 */
!function(a){function b(){}jQuery.event.props.push("dataTransfer");var c={fallback_id:"",url:"",refresh:1e3,paramname:"userfile",requestType:"POST",allowedfileextensions:[],allowedfiletypes:[],maxfiles:25,maxfilesize:1,queuefiles:0,queuewait:200,data:{},headers:{},drop:b,dragStart:b,dragEnter:b,dragOver:b,dragLeave:b,docEnter:b,docOver:b,docLeave:b,beforeEach:b,afterAll:b,rename:b,error:function(a){alert(a)},uploadStarted:b,uploadFinished:b,progressUpdated:b,globalProgressUpdated:b,speedUpdated:b},d=["BrowserNotSupported","TooManyFiles","FileTooLarge","FileTypeNotAllowed","NotFound","NotReadable","AbortError","ReadError","FileExtensionNotAllowed"];a.fn.filedrop=function(b){function e(a){if(w.drop.call(this,a)===!1)return!1;if(a.dataTransfer)return v=a.dataTransfer.files,null===v||void 0===v||0===v.length?(w.error(d[0]),!1):(z=v.length,i(),a.preventDefault(),!1)}function f(b,c,d,e){var f="--",g="\r\n",h="",i=w.paramname;if(w.data){var j=a.param(w.data).replace(/\+/g,"%20").split(/&/);a.each(j,function(){var a=this.split("=",2),b=decodeURIComponent(a[0]),c=decodeURIComponent(a[1]);2===a.length&&(h+=f,h+=e,h+=g,h+='Content-Disposition: form-data; name="'+b+'"',h+=g,h+=g,h+=c,h+=g)})}return jQuery.isFunction(i)&&(i=i(b)),h+=f,h+=e,h+=g,h+='Content-Disposition: form-data; name="'+(i||"")+'"',h+='; filename="'+b+'"',h+=g,h+="Content-Type: "+d,h+=g,h+=g,h+=c,h+=g,h+=f,h+=e,h+=f,h+=g}function g(a){if(a.lengthComputable){var b=Math.round(100*a.loaded/a.total);if(this.currentProgress!==b){this.currentProgress=b,w.progressUpdated(this.index,this.file,this.currentProgress),x[this.global_progress_index]=this.currentProgress,h();var c=(new Date).getTime(),d=c-this.currentStart;if(d>=w.refresh){var e=a.loaded-this.startData,f=e/d;w.speedUpdated(this.index,this.file,f),this.startData=a.loaded,this.currentStart=c}}}}function h(){if(0!==x.length){var a,b=0;for(a in x)x.hasOwnProperty(a)&&(b+=x[a]);w.globalProgressUpdated(Math.round(b/x.length))}}function i(){if(y=!1,!v)return w.error(d[0]),!1;if(w.allowedfiletypes.push&&w.allowedfiletypes.length)for(var b=v.length;b--;)if(!v[b].type||a.inArray(v[b].type,w.allowedfiletypes)<0)return w.error(d[3],v[b]),!1;if(w.allowedfileextensions.push&&w.allowedfileextensions.length)for(var b=v.length;b--;){var c=!1;for(q=0;q<w.allowedfileextensions.length;q++)v[b].name.substr(v[b].name.length-w.allowedfileextensions[q].length)==w.allowedfileextensions[q]&&(c=!0);if(!c)return w.error(d[8],v[b]),!1}var e=0,i=0;if(z>w.maxfiles&&0===w.queuefiles)return w.error(d[1]),!1;for(var n=[],o=[],p=[],q=0;z>q;q++)n.push(q);var r=function(a){setTimeout(s,a)},s=function(){var a;if(y)return!1;if(w.queuefiles>0&&o.length>=w.queuefiles)return r(w.queuewait);a=n[0],n.splice(0,1),o.push(a);try{if(l(v[a])!==!1){if(a===z)return;var b=new FileReader,c=1048576*w.maxfilesize;if(b.index=a,v[a].size>c)return w.error(d[2],v[a],a),o.forEach(function(b,c){b===a&&o.splice(c,1)}),i++,!0;b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:return w.error(d[4]),!1;case a.target.error.NOT_READABLE_ERR:return w.error(d[5]),!1;case a.target.error.ABORT_ERR:return w.error(d[6]),!1;default:return w.error(d[7]),!1}},b.onloadend=w.beforeSend?function(b){w.beforeSend(v[a],a,function(){t(b)})}:t,b.readAsDataURL(v[a])}else i++}catch(e){return o.forEach(function(b,c){b===a&&o.splice(c,1)}),w.error(d[0]),!1}n.length>0&&s()},t=function(b){var c=(b.srcElement||b.target).index;void 0===b.target.index&&(b.target.index=j(b.total));var d,l=new XMLHttpRequest,n=l.upload,q=v[b.target.index],r=b.target.index,s=(new Date).getTime(),t="------multipartformboundary"+(new Date).getTime(),u=x.length,A=k(q.name),B=q.type;w.withCredentials&&(l.withCredentials=w.withCredentials);var C=atob(b.target.result.split(",")[1]);d="string"==typeof A?f(A,C,B,t):f(q.name,C,B,t),n.index=r,n.file=q,n.downloadStartTime=s,n.currentStart=s,n.currentProgress=0,n.global_progress_index=u,n.startData=0,n.addEventListener("progress",g,!1),jQuery.isFunction(w.url)?l.open(w.requestType,w.url(),!0):l.open(w.requestType,w.url,!0),l.setRequestHeader("content-type","multipart/form-data; boundary="+t),l.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.each(w.headers,function(a,b){l.setRequestHeader(a,b)}),l.sendAsBinary(d),x[u]=0,h(),w.uploadStarted(r,q,z),l.onload=function(){var a=null;if(l.responseText)try{a=jQuery.parseJSON(l.responseText)}catch(b){a=l.responseText}var d=(new Date).getTime(),f=d-s,g=w.uploadFinished(r,q,a,f,l);e++,o.forEach(function(a,b){a===c&&o.splice(b,1)}),p.push(c),x[u]=100,h(),e===z-i&&m(),g===!1&&(y=!0),(l.status<200||l.status>299)&&w.error(l.statusText,q,c,l.status)}};s()}function j(a){for(var b=0;z>b;b++)if(v[b].size===a)return b;return void 0}function k(a){return w.rename(a)}function l(a){return w.beforeEach(a)}function m(){return w.afterAll()}function n(a){clearTimeout(u),a.preventDefault(),w.dragEnter.call(this,a)}function o(a){clearTimeout(u),a.preventDefault(),w.docOver.call(this,a),w.dragOver.call(this,a)}function p(a){clearTimeout(u),w.dragLeave.call(this,a),a.stopPropagation()}function q(a){return a.preventDefault(),w.docLeave.call(this,a),!1}function r(a){return clearTimeout(u),a.preventDefault(),w.docEnter.call(this,a),!1}function s(a){return clearTimeout(u),a.preventDefault(),w.docOver.call(this,a),!1}function t(a){u=setTimeout(function(b){return function(){w.docLeave.call(b,a)}}(this),200)}var u,v,w=a.extend({},c,b),x=[],y=!1,z=0;return a("#"+w.fallback_id).css({display:"none",width:0,height:0}),this.on("drop",e).on("dragstart",w.dragStart).on("dragenter",n).on("dragover",o).on("dragleave",p),a(document).on("drop",q).on("dragenter",r).on("dragover",s).on("dragleave",t),this.on("click",function(b){a("#"+w.fallback_id).trigger(b)}),a("#"+w.fallback_id).change(function(a){w.drop(a),v=a.target.files,z=v.length,i()}),this};try{if(XMLHttpRequest.prototype.sendAsBinary)return;XMLHttpRequest.prototype.sendAsBinary=function(a){function b(a){return 255&a.charCodeAt(0)}var c=Array.prototype.map.call(a,b),d=new Uint8Array(c);this.send("ArrayBufferView"in window?d:d.buffer)}}catch(e){}}(jQuery),function(a){{var b=Backbone.View.extend({el:".splash.dropspot",input:"input.dropspot",settings:{url:"/upload",maxfilesize:3},initialize:function(){_.bindAll(this,"finished"),_.extend(this.settings,{uploadFinished:this.finished}),this.render()},render:function(){a(this.el).filedrop(this.settings)},finished:function(b,c,d){this.$el.css("background-image","url("+d+")"),a(this.input).val(d)}});new b}}(jQuery);